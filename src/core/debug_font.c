#include <nusys.h>
#include <string.h>

#include "debug_font.h"
#include "debug.h"

const u8 debug_font_width = 6;
const u8 debug_font_height = 8;
const u8 debug_font_char_per_line = 16;

static const u8 debug_font[] __attribute__((aligned(8))) = {
  0x00,0x10,0x6C,0x00,0x20,0x64,0x20,0x30,0x10,0x22,0x00,0x00,0x00,0x00,0x00,0x00, // ...........#.....##.##............#......##..#....#.......##.......#......#...#.................................................
  0x00,0x38,0x6C,0x28,0x38,0x64,0x50,0x30,0x20,0x10,0x28,0x10,0x00,0x00,0x00,0x04, // ..........###....##.##....#.#.....###....##..#...#.#......##......#........#......#.#......#.................................#..
  0x00,0x38,0x48,0x7C,0x40,0x08,0x50,0x20,0x20,0x10,0x38,0x10,0x00,0x00,0x00,0x08, // ..........###....#..#....#####...#..........#....#.#......#.......#........#......###......#................................#...
  0x00,0x10,0x00,0x28,0x30,0x10,0x20,0x00,0x20,0x10,0x7C,0x7C,0x00,0x7C,0x00,0x10, // ...........#..............#.#.....##.......#......#...............#........#.....#####...#####...........#####.............#....
  0x00,0x10,0x00,0x28,0x08,0x20,0x54,0x00,0x20,0x10,0x38,0x10,0x00,0x00,0x00,0x20, // ...........#..............#.#.......#.....#......#.#.#............#........#......###......#..............................#.....
  0x00,0x00,0x00,0x7C,0x70,0x4C,0x48,0x00,0x20,0x10,0x28,0x10,0x30,0x00,0x30,0x40, // .........................#####...###.....#..##...#..#.............#........#......#.#......#......##..............##.....#......
  0x00,0x10,0x00,0x28,0x10,0x4C,0x34,0x00,0x10,0x20,0x00,0x00,0x30,0x00,0x30,0x00, // ...........#..............#.#......#.....#..##....##.#.............#......#.......................##..............##............
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00, // ..................................................................................................#.............................
  0x38,0x10,0x38,0x38,0x08,0x7C,0x18,0x7C,0x38,0x38,0x00,0x00,0x08,0x00,0x20,0x38, // ..###......#......###.....###.......#....#####.....##....#####....###.....###.......................#.............#.......###...
  0x44,0x30,0x44,0x44,0x18,0x40,0x20,0x04,0x44,0x44,0x00,0x00,0x10,0x00,0x10,0x44, // .#...#....##.....#...#...#...#.....##....#........#..........#...#...#...#...#.....................#...............#.....#...#..
  0x4C,0x10,0x04,0x04,0x28,0x40,0x40,0x08,0x44,0x44,0x30,0x30,0x20,0x7C,0x08,0x04, // .#..##.....#.........#.......#....#.#....#.......#..........#....#...#...#...#....##......##......#......#####......#........#..
  0x54,0x10,0x18,0x38,0x48,0x78,0x78,0x10,0x38,0x3C,0x30,0x30,0x40,0x00,0x04,0x18, // .#.#.#.....#.......##.....###....#..#....####....####......#......###.....####....##......##.....#...................#.....##...
  0x64,0x10,0x20,0x04,0x7C,0x04,0x44,0x20,0x44,0x04,0x00,0x00,0x20,0x00,0x08,0x10, // .##..#.....#......#..........#...#####.......#...#...#....#......#...#.......#....................#.................#......#....
  0x44,0x10,0x40,0x44,0x08,0x44,0x44,0x20,0x44,0x08,0x30,0x30,0x10,0x7C,0x10,0x00, // .#...#.....#.....#.......#...#......#....#...#...#...#....#......#...#......#.....##......##.......#.....#####.....#............
  0x38,0x38,0x7C,0x38,0x08,0x38,0x38,0x20,0x38,0x30,0x30,0x30,0x08,0x00,0x20,0x10, // ..###.....###....#####....###.......#.....###.....###.....#.......###.....##......##......##........#.............#........#....
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00, // ..........................................................................................#.....................................
  0x38,0x38,0x78,0x38,0x78,0x7C,0x7C,0x38,0x44,0x38,0x04,0x44,0x40,0x44,0x44,0x38, // ..###.....###....####.....###....####....#####...#####....###....#...#....###........#...#...#...#.......#...#...#...#....###...
  0x44,0x44,0x44,0x44,0x44,0x40,0x40,0x44,0x44,0x10,0x04,0x48,0x40,0x6C,0x64,0x44, // .#...#...#...#...#...#...#...#...#...#...#.......#.......#...#...#...#.....#.........#...#..#....#.......##.##...##..#...#...#..
  0x5C,0x44,0x44,0x40,0x44,0x40,0x40,0x40,0x44,0x10,0x04,0x50,0x40,0x54,0x54,0x44, // .#.###...#...#...#...#...#.......#...#...#.......#.......#.......#...#.....#.........#...#.#.....#.......#.#.#...#.#.#...#...#..
  0x54,0x44,0x78,0x40,0x44,0x78,0x78,0x5C,0x7C,0x10,0x04,0x60,0x40,0x44,0x4C,0x44, // .#.#.#...#...#...####....#.......#...#...####....####....#.###...#####.....#.........#...##......#.......#...#...#..##...#...#..
  0x5C,0x7C,0x44,0x40,0x44,0x40,0x40,0x44,0x44,0x10,0x44,0x50,0x40,0x44,0x44,0x44, // .#.###...#####...#...#...#.......#...#...#.......#.......#...#...#...#.....#.....#...#...#.#.....#.......#...#...#...#...#...#..
  0x40,0x44,0x44,0x44,0x44,0x40,0x40,0x44,0x44,0x10,0x44,0x48,0x40,0x44,0x44,0x44, // .#.......#...#...#...#...#...#...#...#...#.......#.......#...#...#...#.....#.....#...#...#..#....#.......#...#...#...#...#...#..
  0x38,0x44,0x78,0x38,0x78,0x7C,0x40,0x3C,0x44,0x38,0x38,0x44,0x7C,0x44,0x44,0x38, // ..###....#...#...####.....###....####....#####...#........####...#...#....###.....###....#...#...#####...#...#...#...#....###...
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................................................................................................................
  0x78,0x38,0x78,0x38,0x7C,0x44,0x44,0x44,0x44,0x44,0x78,0x38,0x00,0x38,0x10,0x00, // .####.....###....####.....###....#####...#...#...#...#...#...#...#...#...#...#...####.....###.............###......#............
  0x44,0x44,0x44,0x44,0x10,0x44,0x44,0x44,0x44,0x44,0x08,0x20,0x40,0x08,0x28,0x00, // .#...#...#...#...#...#...#...#.....#.....#...#...#...#...#...#...#...#...#...#......#.....#......#..........#.....#.#...........
  0x44,0x44,0x44,0x40,0x10,0x44,0x44,0x54,0x28,0x44,0x10,0x20,0x20,0x08,0x44,0x00, // .#...#...#...#...#...#...#.........#.....#...#...#...#...#.#.#....#.#....#...#.....#......#.......#.........#....#...#..........
  0x78,0x44,0x78,0x38,0x10,0x44,0x44,0x54,0x10,0x28,0x20,0x20,0x10,0x08,0x00,0x00, // .####....#...#...####.....###......#.....#...#...#...#...#.#.#.....#......#.#.....#.......#........#........#...................
  0x40,0x54,0x48,0x04,0x10,0x44,0x44,0x54,0x28,0x10,0x40,0x20,0x08,0x08,0x00,0x00, // .#.......#.#.#...#..#........#.....#.....#...#...#...#...#.#.#....#.#......#.....#........#.........#.......#...................
  0x40,0x48,0x44,0x44,0x10,0x44,0x28,0x54,0x44,0x10,0x40,0x20,0x04,0x08,0x00,0x00, // .#.......#..#....#...#...#...#.....#.....#...#....#.#....#.#.#...#...#.....#.....#........#..........#......#...................
  0x40,0x34,0x44,0x38,0x10,0x38,0x10,0x28,0x44,0x10,0x78,0x38,0x00,0x38,0x00,0x00, // .#........##.#...#...#....###......#......###......#......#.#....#...#.....#.....####.....###.............###...................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC, // ........................................................................................................................######..
  0x30,0x00,0x40,0x00,0x04,0x00,0x18,0x00,0x40,0x10,0x08,0x40,0x10,0x00,0x00,0x00, // ..##.............#...................#.............##............#.........#........#....#.........#............................
  0x30,0x00,0x40,0x00,0x04,0x00,0x20,0x00,0x40,0x00,0x00,0x40,0x10,0x00,0x00,0x00, // ..##.............#...................#............#..............#.......................#.........#............................
  0x10,0x38,0x78,0x38,0x3C,0x38,0x20,0x3C,0x70,0x10,0x18,0x48,0x10,0x68,0x70,0x38, // ...#......###....####.....###.....####....###.....#.......####...###.......#.......##....#..#......#.....##.#....###......###...
  0x00,0x04,0x44,0x44,0x44,0x44,0x78,0x44,0x48,0x10,0x08,0x50,0x10,0x54,0x48,0x44, // .............#...#...#...#...#...#...#...#...#...####....#...#...#..#......#........#....#.#.......#.....#.#.#...#..#....#...#..
  0x00,0x3C,0x44,0x40,0x44,0x78,0x20,0x44,0x48,0x10,0x08,0x60,0x10,0x54,0x48,0x44, // ..........####...#...#...#.......#...#...####.....#......#...#...#..#......#........#....##........#.....#.#.#...#..#....#...#..
  0x00,0x44,0x44,0x44,0x44,0x40,0x20,0x3C,0x48,0x10,0x08,0x50,0x10,0x44,0x48,0x44, // .........#...#...#...#...#...#...#...#...#........#.......####...#..#......#........#....#.#.......#.....#...#...#..#....#...#..
  0x00,0x3C,0x78,0x38,0x3C,0x38,0x20,0x04,0x48,0x18,0x48,0x48,0x18,0x44,0x48,0x38, // ..........####...####.....###.....####....###.....#..........#...#..#......##....#..#....#..#......##....#...#...#..#.....###...
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00, // ..........................................................###.....................##............................................
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x10,0x30,0x28,0x10, // ...........................................................................................##......#......##......#.#......#....
  0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x10,0x08,0x50,0x38, // ..................................#.......................................................#........#........#....#.#......###...
  0x78,0x3C,0x58,0x38,0x78,0x48,0x44,0x44,0x48,0x48,0x78,0x20,0x10,0x08,0x00,0x6C, // .####.....####...#.##.....###....####....#..#....#...#...#...#...#..#....#..#....####.....#........#........#............##.##..
  0x44,0x44,0x24,0x40,0x20,0x48,0x44,0x44,0x48,0x48,0x08,0x60,0x00,0x0C,0x00,0x44, // .#...#...#...#....#..#...#........#......#..#....#...#...#...#...#..#....#..#.......#....##.................##...........#...#..
  0x44,0x44,0x20,0x38,0x20,0x48,0x44,0x54,0x30,0x48,0x30,0x20,0x10,0x08,0x00,0x44, // .#...#...#...#....#.......###.....#......#..#....#...#...#.#.#....##.....#..#.....##......#........#........#............#...#..
  0x44,0x44,0x20,0x04,0x28,0x58,0x28,0x7C,0x48,0x38,0x40,0x20,0x10,0x08,0x00,0x7C, // .#...#...#...#....#..........#....#.#....#.##.....#.#....#####...#..#.....###....#........#........#........#............#####..
  0x78,0x3C,0x70,0x38,0x10,0x28,0x10,0x28,0x48,0x10,0x78,0x18,0x10,0x30,0x00,0x00, // .####.....####...###......###......#......#.#......#......#.#....#..#......#.....####......##......#......##....................
  0x40,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x02,0x00,0x00,0x00  // .#...........#...........................................................##...........................#.........................
};

void debug_draw_char(u16* buffer, u32 x, u32 y, char c) {
    u8 index = (u8)c - 32;
    u32 xOffset = (index % debug_font_char_per_line);
    u32 yOffset = (index / debug_font_char_per_line) * debug_font_char_per_line * debug_font_height;

    u32 offset = xOffset + yOffset;
    u32 fbX = x; u32 fbY = y;

    for(int i = 0; i < debug_font_height; i++) {
        u8 pixel = debug_font[offset + (debug_font_char_per_line * i)];
        for(int j = 0; j < 6; j++) {
            buffer[320 + (fbY * 320) + fbX] = pixel & (0x80 >> j) ? 0xFFFF : 0x0001;
            fbX++;
        }
        fbX = x;
        fbY++;
    }
}

void debug_draw_string(u16* buffer, u32 x, u32 y, char* message) {
    size_t size = strlen(message);
    for(size_t i = 0; i < size; i++) {
        char c = message[i];
        debug_draw_char(buffer, x + (i * debug_font_width), y, c);
    }

}